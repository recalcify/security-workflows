name: Dependency and Supply Chain Check

on:
  push:
      branches: [ main, develop ]
          paths: [ 'package.json', 'package-lock.json', 'requirements.txt', 'Gemfile', 'pom.xml' ]
            pull_request:
                branches: [ main, develop ]
                    paths: [ 'package.json', 'package-lock.json', 'requirements.txt', 'Gemfile', 'pom.xml' ]
                      schedule:
                          - cron: '0 0 * * 0'  # Weekly scan

                          jobs:
                            dependency-check:
                                runs-on: ubuntu-latest
                                    permissions:
                                          contents: read
                                                security-events: write

                                                    steps:
                                                          - name: Checkout code
                                                                  uses: actions/checkout@v4

                                                                        - name: Run OWASP Dependency-Check
                                                                                uses: dependency-check/Dependency-Check_Action@main
                                                                                        with:
                                                                                                  project: 'security-workflows'
                                                                                                            path: '.'
                                                                                                                      format: 'JSON'
                                                                                                                                args: >
                                                                                                                                            --enableRetired
                                                                                                                                                        --enableExperimental
                                                                                                                                                        
                                                                                                                                                              - name: Upload Dependency-Check results
                                                                                                                                                                      uses: github/codeql-action/upload-sarif@v2
                                                                                                                                                                              if: always()
                                                                                                                                                                                      with:
                                                                                                                                                                                                sarif_file: './dependency-check-report.sarif'
                                                                                                                                                                                                
                                                                                                                                                                                                      - name: Check npm dependencies for known vulnerabilities
                                                                                                                                                                                                              run: |
                                                                                                                                                                                                                        if [ -f package.json ]; then
                                                                                                                                                                                                                                    npm audit --audit-level=moderate || true
                                                                                                                                                                                                                                              fi
                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                    - name: Check Python dependencies
                                                                                                                                                                                                                                                            run: |
                                                                                                                                                                                                                                                                      if [ -f requirements.txt ]; then
                                                                                                                                                                                                                                                                                  pip install safety
                                                                                                                                                                                                                                                                                              safety check -r requirements.txt --json || true
                                                                                                                                                                                                                                                                                                        fi
                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                              - name: Verify package integrity
                                                                                                                                                                                                                                                                                                                      run: |
                                                                                                                                                                                                                                                                                                                                if [ -f package-lock.json ]; then
                                                                                                                                                                                                                                                                                                                                            npm ci --dry-run
                                                                                                                                                                                                                                                                                                                                                      fi
