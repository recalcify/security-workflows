name: Security Master Orchestrator

on:
  push:
      branches: [ main, develop, master ]
        pull_request:
            branches: [ main, develop, master ]
              schedule:
                  - cron: '0 0 * * 0'  # Weekly

                  concurrency:
                    group: ${{ github.workflow }}-${{ github.ref }}
                      cancel-in-progress: true

                      jobs:
                        code-security:
                            name: Code Security Scanning
                                uses: recalcify/security-workflows/.github/workflows/code-security.yml@main
                                    secrets: inherit
                                        permissions:
                                              contents: read
                                                    security-events: write

                                                      dependency-check:
                                                          name: Dependency & Supply Chain
                                                              uses: recalcify/security-workflows/.github/workflows/dependency-check.yml@main
                                                                  secrets: inherit
                                                                      permissions:
                                                                            contents: read
                                                                                  security-events: write

                                                                                    sast-analysis:
                                                                                        name: Static Application Security Testing
                                                                                            uses: recalcify/security-workflows/.github/workflows/sast-analysis.yml@main
                                                                                                secrets: inherit
                                                                                                    permissions:
                                                                                                          contents: read
                                                                                                                security-events: write
                                                                                                                
                                                                                                                  secret-scanning:
                                                                                                                      name: Secret & Credential Detection
                                                                                                                          uses: recalcify/security-workflows/.github/workflows/secret-scanning.yml@main
                                                                                                                              secrets: inherit
                                                                                                                                  permissions:
                                                                                                                                        contents: read
                                                                                                                                              security-events: write
                                                                                                                                              
                                                                                                                                                security-summary:
                                                                                                                                                    name: Security Summary
                                                                                                                                                        runs-on: ubuntu-latest
                                                                                                                                                            needs: [ code-security, dependency-check, sast-analysis, secret-scanning ]
                                                                                                                                                                if: always()
                                                                                                                                                                    steps:
                                                                                                                                                                          - name: Check all security checks passed
                                                                                                                                                                                  run: |
                                                                                                                                                                                            if [[ "${{ needs.code-security.result }}" != "success" ]] && [[ "${{ needs.code-security.result }}" != "skipped" ]]; then
                                                                                                                                                                                                        echo "❌ Code Security Scanning FAILED"
                                                                                                                                                                                                                    exit 1
                                                                                                                                                                                                                              fi
                                                                                                                                                                                                                                        if [[ "${{ needs.dependency-check.result }}" != "success" ]] && [[ "${{ needs.dependency-check.result }}" != "skipped" ]]; then
                                                                                                                                                                                                                                                    echo "❌ Dependency Check FAILED"
                                                                                                                                                                                                                                                                exit 1
                                                                                                                                                                                                                                                                          fi
                                                                                                                                                                                                                                                                                    if [[ "${{ needs.sast-analysis.result }}" != "success" ]] && [[ "${{ needs.sast-analysis.result }}" != "skipped" ]]; then
                                                                                                                                                                                                                                                                                                echo "❌ SAST Analysis FAILED"
                                                                                                                                                                                                                                                                                                            exit 1
                                                                                                                                                                                                                                                                                                                      fi
                                                                                                                                                                                                                                                                                                                                if [[ "${{ needs.secret-scanning.result }}" != "success" ]] && [[ "${{ needs.secret-scanning.result }}" != "skipped" ]]; then
                                                                                                                                                                                                                                                                                                                                            echo "❌ Secret Scanning FAILED"
                                                                                                                                                                                                                                                                                                                                                        exit 1
                                                                                                                                                                                                                                                                                                                                                                  fi
                                                                                                                                                                                                                                                                                                                                                                            echo "✅ All security checks passed!"
